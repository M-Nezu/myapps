<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokyo GeoGuessr (GAS Ver)</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; overflow: hidden; }
        
        #pano { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; background: #f0f0f0; }

        /* å³ä¸‹ã®ãƒãƒƒãƒ— */
        #map-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 320px;
            height: 240px;
            z-index: 10;
            border: 3px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: width 0.3s, height 0.3s;
            background: #eee;
        }
        #map-container.expanded { 
            width: 500px; 
            height: 400px; 
        }
        #map { width: 100%; height: 100%; }

        /* ãƒãƒƒãƒ—ç¸®å°ãƒœã‚¿ãƒ³ */
        .close-map-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            background: #ff5252;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            line-height: 1;
            padding: 0;
        }
        .close-map-btn:hover { background: #d32f2f; }
        #map-container.expanded .close-map-btn { display: flex; }

        /* å·¦ä¸Šã®æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 20;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 8px;
            pointer-events: none;
            width: 30vw;
            max-width: 30vw;
            max-height: 15vh;
            padding: 1.5vmin;
            font-size: 1.5vmin;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }
        #ui-layer h1 { 
            margin: 0 0 0.8vmin 0; 
            font-size: 1.8vmin; 
            border-bottom: 1px solid #555; 
            padding-bottom: 0.5vmin;
            white-space: nowrap;
        }
        .stat-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 0.3vmin;
            line-height: 1.2;
        }
        .info-text {
            margin-top: 0.8vmin; 
            font-size: 1.2vmin; 
            color: #aaa;
            line-height: 1.2;
        }
        .stat-val { font-weight: bold; color: #4CAF50; }
        .stat-err { color: #ff5252; }

        /* æ“ä½œãƒœã‚¿ãƒ³ */
        #controls {
            position: absolute;
            bottom: 270px; /* é€šå¸¸æ™‚ã®ä½ç½® (map height 240 + bottom 20 + gap 10) */
            right: 20px;
            z-index: 20;
            text-align: right;
            transition: bottom 0.3s; /* ãƒãƒƒãƒ—æ‹¡å¤§ã«åˆã‚ã›ã¦æ»‘ã‚‰ã‹ã«å‹•ãã‚ˆã†ã«ã™ã‚‹ */
        }
        /* ãƒãƒƒãƒ—ãŒæ‹¡å¤§ã•ã‚ŒãŸã¨ãã®ä½ç½®èª¿æ•´ (map height 400 + bottom 20 + gap 10) */
        #map-container.expanded ~ #controls {
            bottom: 430px;
        }

        button.guess-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
            font-weight: bold;
        }
        button.guess-btn:hover { background: #1976D2; }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º */
        #message-toast {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 20px 30px;
            z-index: 30;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            font-size: 1.2rem;
            border: 2px solid #333;
        }

        /* APIã‚­ãƒ¼å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #api-key-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .modal-content h2 { margin-top: 0; color: #333; }
        .modal-content input {
            width: 80%;
            padding: 10px;
            margin: 15px 0;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .modal-content button {
            background: #4CAF50;
            width: 50%;
            padding: 10px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        .note { font-size: 0.9rem; color: #666; margin-bottom: 15px; text-align: left; }

        /* è¨­å®šãƒœã‚¿ãƒ³ */
        #settings-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 40;
            background: rgba(0,0,0,0.75);
            color: white;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
        }
        #settings-btn:hover { background: rgba(0,0,0,0.9); }

        /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
        #settings-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.75);
            z-index: 120;
            align-items: center;
            justify-content: center;
        }
        #settings-modal .settings-content {
            background: white;
            padding: 20px 24px;
            border-radius: 10px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            color: #333;
        }
        #settings-modal h3 { margin: 0 0 12px; }
        .settings-field { margin-bottom: 14px; }
        .settings-field label { display: block; font-weight: bold; margin-bottom: 6px; }
        .settings-field input {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        .settings-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        .settings-actions button {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }
        .settings-cancel { background: #e0e0e0; color: #333; }
        .settings-apply { background: #1976D2; color: white; }
    </style>
</head>
<body>

    <button id="settings-btn" aria-label="è¨­å®š">âš™ï¸</button>

    <div id="api-key-modal">
        <div class="modal-content">
            <h2>APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™</h2>
            <p>Google Maps APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
            <div class="note">
                â€» Maps JavaScript API ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br>
                â€» å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã€æ¬¡å›ã‹ã‚‰è‡ªå‹•ã§ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
            </div>
            <input type="text" id="api-key-input" placeholder="AIzaSy...">
            <br>
            <button onclick="submitApiKey()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>
    </div>

    <div id="pano"></div>

    <div id="ui-layer">
        <h1>æ±äº¬ 30kmåœå†…</h1>
        <div class="stat-row">Round: <span class="stat-val" id="round-disp">1</span></div>
        <div class="stat-row">æˆåŠŸæ•°: <span class="stat-val" id="success-disp">0</span></div>
        <div class="stat-row">å¤±æ•—æ•°: <span class="stat-val stat-err" id="fail-disp">0</span></div>
        <div class="info-text">
            ç¾åœ¨åœ°ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚<br>èª¤å·®30mä»¥å†…ã§ã‚¯ãƒªã‚¢ï¼
        </div>
    </div>

    <!-- ãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div id="map-container">
        <button class="close-map-btn" onclick="closeMap(event)">Ã—</button>
        <div id="map"></div>
    </div>

    <div id="controls">
        <button class="guess-btn" id="guess-btn" onclick="checkGuess()">GUESS !</button>
    </div>

    <div id="message-toast"></div>

    <div id="settings-modal">
        <div class="settings-content">
            <h3>è¨­å®š</h3>
            <div class="settings-field">
                <label for="place-input">åœ°å</label>
                <input type="text" id="place-input" placeholder="ä¾‹: æ±äº¬é§…" autocomplete="off">
            </div>
            <div class="settings-field">
                <label for="radius-input">å‡ºé¡Œç¯„å›²ã®åŠå¾„ (km)</label>
                <input type="number" id="radius-input" min="1" step="0.1" value="30">
            </div>
            <div class="settings-actions">
                <button class="settings-cancel" onclick="closeSettings()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="settings-apply" onclick="applySettings()">å¤‰æ›´</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        //  è¨­å®š: APIã‚­ãƒ¼ (åˆæœŸå€¤ã¯ç©º)
        // ==========================================
        var googleMapsApiKey = "";
        // ==========================================

        var TOKYO_CENTER = { lat: 35.681236, lng: 139.767125 };
        var RADIUS_KM = 30;
        var BASE_NAME = "æ±äº¬";
        
        var round = 1;
        var successCount = 0;
        var failCount = 0;
        var map, panorama, svService, guessMarker, geocoder;
        var mapContainer = document.getElementById("map-container");

        var headerTitle = document.querySelector('#ui-layer h1');

        // GASå¯¾ç­–: DOMContentLoadedãŒç™ºç«ã—ãªã„å ´åˆãŒã‚ã‚‹ã®ã§window.onloadã‚‚è€ƒæ…®
        window.onload = function() {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰APIã‚­ãƒ¼å–å¾—ã‚’è©¦ã¿ã‚‹
            // ã‚­ãƒ¼åã‚’å¤‰æ›´: GOOGLE_MAPS_API_KEY
            var savedKey = localStorage.getItem('GOOGLE_MAPS_API_KEY');

            if (savedKey && savedKey.trim() !== "") {
                // ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€ãã‚Œã‚’ä½¿ç”¨
                googleMapsApiKey = savedKey;
                loadGoogleMapsScript(googleMapsApiKey);
            } else {
                // ã‚­ãƒ¼ãŒãªã„å ´åˆã€ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                document.getElementById('api-key-modal').style.display = 'flex';
            }
        };
        
        // Google Maps APIã®èªè¨¼å¤±æ•—æ™‚ã«å‘¼ã°ã‚Œã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.gm_authFailure = function() {
            alert("Google Maps APIã®èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nä¿å­˜ã•ã‚ŒãŸã‚­ãƒ¼ãŒç„¡åŠ¹ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\nã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚");
            // é–“é•ã£ãŸã‚­ãƒ¼ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆ
            localStorage.removeItem('GOOGLE_MAPS_API_KEY');
            location.reload();
        };

        function submitApiKey() {
            var input = document.getElementById('api-key-input');
            var key = input.value.trim();
            if (key) {
                googleMapsApiKey = key;
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ (ã‚­ãƒ¼åã‚’å¤‰æ›´)
                localStorage.setItem('GOOGLE_MAPS_API_KEY', key);

                document.getElementById('api-key-modal').style.display = 'none';
                loadGoogleMapsScript(key);
            } else {
                alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            }
        }

        function loadGoogleMapsScript(key) {
            var script = document.createElement('script');
            // ã€é‡è¦ã€‘GASã§SyntaxErrorã«ãªã‚‰ãªã„ã‚ˆã†ã€ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆã‚’ä½¿ã‚ãšæ–‡å­—åˆ—çµåˆã«ã™ã‚‹
            script.src = 'https://maps.googleapis.com/maps/api/js?key=' + key + '&callback=initGame&v=weekly';
            script.async = true;
            script.defer = true;
            script.onerror = function() {
                // ãƒ­ãƒ¼ãƒ‰å¤±æ•—æ™‚ã®ã¿ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å†è¡¨ç¤º
                alert("Google Maps APIã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                document.getElementById('api-key-modal').style.display = 'flex';
            };
            document.head.appendChild(script);
        }

        // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°: APIãƒ­ãƒ¼ãƒ‰å¾Œã«å‘¼ã°ã‚Œã‚‹
        window.initGame = function() {
            // ã€é‡è¦ã€‘APIãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œåœ°å›³åˆæœŸåŒ–ãŒå§‹ã¾ã£ãŸã‚‰ã€å¼·åˆ¶çš„ã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’æ¶ˆã™
            document.getElementById('api-key-modal').style.display = 'none';

            svService = new google.maps.StreetViewService();
            geocoder = new google.maps.Geocoder();

            panorama = new google.maps.StreetViewPanorama(
                document.getElementById("pano"), {
                    pov: { heading: 0, pitch: 0 },
                    linksControl: true,
                    clickToGo: true,
                    addressControl: false,
                    showRoadLabels: false,
                    fullscreenControl: false,
                    motionTracking: false,
                    motionTrackingControl: false
                }
            );

            map = new google.maps.Map(document.getElementById("map"), {
                center: TOKYO_CENTER,
                zoom: 10,
                streetViewControl: false,
                mapTypeControl: false,
                fullscreenControl: false,
                clickableIcons: false,
                gestureHandling: 'greedy'
            });

            updateHeader();

            map.addListener("click", function(e) {
                if (guessMarker) {
                    guessMarker.setPosition(e.latLng);
                } else {
                    guessMarker = new google.maps.Marker({
                        position: e.latLng,
                        map: map,
                        label: "?"
                    });
                }
                mapContainer.classList.add('expanded');
            });

            document.addEventListener('click', function(event) {
                if (!mapContainer.contains(event.target) && mapContainer.classList.contains('expanded')) {
                    mapContainer.classList.remove('expanded');
                }
            });

            startNewRound();
        };

        window.closeMap = function(event) {
            event.stopPropagation();
            mapContainer.classList.remove('expanded');
        };

        function startNewRound() {
            showToast("å ´æ‰€ã‚’æ¤œç´¢ä¸­...", false);
            findRandomStreetView();
        }

        function resetGame() {
            round = 1;
            successCount = 0;
            failCount = 0;
            document.getElementById("round-disp").innerText = round;
            document.getElementById("success-disp").innerText = successCount;
            document.getElementById("fail-disp").innerText = failCount;
            if (guessMarker) {
                guessMarker.setMap(null);
                guessMarker = null;
            }
            if (map) {
                map.setCenter(TOKYO_CENTER);
                map.setZoom(10);
            }
            updateHeader();
            startNewRound();
        }

        function findRandomStreetView() {
            var randomLoc = getRandomLatLngInTokyo(RADIUS_KM);

            svService.getPanorama({
                location: randomLoc,
                radius: 100,
                source: google.maps.StreetViewSource.OUTDOOR
            }).then(function(result) {
                var location = result.data.location;
                panorama.setPano(location.pano);
                panorama.setPov({ heading: 0, pitch: 0 });
                panorama.setVisible(true);

                if (guessMarker) guessMarker.setMap(null);
                guessMarker = null;
                
                map.setCenter(TOKYO_CENTER);
                map.setZoom(10);
                
                hideToast();

            }).catch(function() {
                console.log("Retrying SV search...");
                findRandomStreetView();
            });
        }

        function updateHeader() {
            var radiusText = RADIUS_KM % 1 === 0 ? RADIUS_KM : RADIUS_KM.toFixed(1);
            headerTitle.textContent = BASE_NAME + " " + radiusText + "kmåœå†…";
        }

        window.checkGuess = function() {
            if (!guessMarker) {
                alert("ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç¾åœ¨åœ°ã‚’äºˆæƒ³ã—ã¦ãã ã•ã„ï¼");
                return;
            }

            var currentPanoPos = panorama.getPosition();
            var guessPos = guessMarker.getPosition();

            var distanceKm = calculateDistance(
                currentPanoPos.lat(), currentPanoPos.lng(),
                guessPos.lat(), guessPos.lng()
            );
            var distanceMeters = Math.round(distanceKm * 1000);

            if (distanceMeters <= 30) {
                successCount++;
                document.getElementById("success-disp").innerText = successCount;
                
                showToast("ğŸ‰ æ­£è§£ï¼<br>èª¤å·®: " + distanceMeters + "m<br>æ¬¡ã®å ´æ‰€ã¸é€²ã¿ã¾ã™", true);
                mapContainer.classList.remove('expanded');

                setTimeout(function() {
                    round++;
                    document.getElementById("round-disp").innerText = round;
                    startNewRound();
                }, 2000);

            } else {
                failCount++;
                document.getElementById("fail-disp").innerText = failCount;
                
                var msg = "æƒœã—ã„ï¼<br>æ­£è§£ã¨ã®è·é›¢: <b>" + distanceMeters + "m</b><br>ã‚‚ã£ã¨è¿‘ã¥ã„ã¦ãã ã•ã„ã€‚";
                if(distanceMeters > 1000) {
                    msg = "å…¨ç„¶é•ã„ã¾ã™ï¼<br>æ­£è§£ã¨ã®è·é›¢: <b>" + (distanceKm).toFixed(1) + "km</b><br>è«¦ã‚ãšã«æ¢ã—ã¦ãã ã•ã„ã€‚";
                }
                showToast(msg, true);
                
                setTimeout(function() {
                    hideToast();
                }, 3000);
            }
        };

        function getRandomLatLngInTokyo(radiusKm) {
            var r = radiusKm / 111.32; 
            var y0 = TOKYO_CENTER.lat;
            var x0 = TOKYO_CENTER.lng;
            
            var u = Math.random();
            var v = Math.random();
            var w = r * Math.sqrt(u);
            var t = 2 * Math.PI * v;
            var x = w * Math.cos(t);
            var y = w * Math.sin(t);

            var newLat = y + y0;
            var newLng = x / Math.cos(y0 * Math.PI / 180) + x0;

            return { lat: newLat, lng: newLng };
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        function showToast(html, autoHide) {
            var toast = document.getElementById("message-toast");
            toast.innerHTML = html;
            toast.style.display = "block";
        }
        function hideToast() {
            document.getElementById("message-toast").style.display = "none";
        }

        window.openSettings = function() {
            document.getElementById('place-input').value = BASE_NAME;
            document.getElementById('radius-input').value = RADIUS_KM;
            document.getElementById('settings-modal').style.display = 'flex';
        };

        window.closeSettings = function() {
            document.getElementById('settings-modal').style.display = 'none';
        };

        window.applySettings = function() {
            var place = document.getElementById('place-input').value.trim();
            var radiusVal = parseFloat(document.getElementById('radius-input').value);
            if (!place) {
                alert('åœ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!(radiusVal > 0)) {
                alert('åŠå¾„ã¯æ­£ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!geocoder) {
                alert('Google Mapsã®åˆæœŸåŒ–ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                return;
            }

            geocoder.geocode({ address: place }, function(results, status) {
                if (status === 'OK' && results && results[0]) {
                    var loc = results[0].geometry.location;
                    TOKYO_CENTER = { lat: loc.lat(), lng: loc.lng() };
                    RADIUS_KM = radiusVal;
                    BASE_NAME = place;
                    closeSettings();
                    resetGame();
                } else {
                    alert('ä½ç½®ã®æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + status);
                }
            });
        };

        document.getElementById('settings-btn').addEventListener('click', openSettings);
    </script>
</body>
</html>